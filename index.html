<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <title>CardVault ‚Äî Mobile</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root{
      --bg:#0b1020; --surface:#0f172a; --surface-2:#111827;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; --accent-2:#a78bfa; --danger:#ef4444;
      --radius:16px; --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box}
    html, body { height: 100%; }
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial; color:var(--text);
      background:
        radial-gradient(1000px 700px at 100% -5%, rgba(34,211,238,.08), transparent 60%),
        radial-gradient(900px 600px at -10% 100%, rgba(167,139,250,.08), transparent 60%),
        var(--bg);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    header{ position:sticky; top:0; z-index:50; backdrop-filter: blur(10px); background: rgba(11,16,32,.7);
      border-bottom: 1px solid rgba(148,163,184,.15); }
    .wrap{max-width:820px; margin:0 auto; padding:12px 14px;}
    h1{margin:0; font-size:18px; letter-spacing:.3px; display:flex; align-items:center; gap:8px}
    .badge{font-size:11px; padding:2px 8px; border:1px solid rgba(148,163,184,.3); border-radius:999px; color:var(--muted)}
    .search{ display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:14px;
      background:rgba(17,24,39,.9); border:1px solid rgba(148,163,184,.18); margin-top:10px; }
    .search input{flex:1; background:transparent; outline:none; border:0; color:var(--text); font-size:16px}
    main{min-height: calc(100svh - 110px); padding:12px 14px 96px; max-width:820px; margin:0 auto;}
    .card{background:rgba(15,23,42,.9); border:1px solid rgba(148,163,184,.18); border-radius:var(--radius); padding:12px}
    .section-title{margin:0 0 8px 0; font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .preview{display:flex; gap:10px; overflow-x:auto; padding-bottom:6px}
    .thumb{width:42%; max-width:220px; min-width:150px; aspect-ratio:3/2; background:#0b1020;
           border:1px dashed rgba(148,163,184,.35); display:flex; align-items:center; justify-content:center;
           border-radius:12px; overflow:hidden; flex:0 0 auto}
    .thumb img{width:100%; height:100%; object-fit:cover}
    label.file{display:inline-flex; align-items:center; gap:8px}
    input[type=file]{display:none}
    .btn{cursor:pointer; border:1px solid rgba(148,163,184,.28); background:rgba(17,24,39,.6); color:var(--text);
         border-radius:12px; padding:12px 14px; font-weight:700; transition:.2s; font-size:15px; min-height:48px}
    .btn:active{transform: translateY(1px);}
    .btn.primary{background:linear-gradient(135deg, rgba(34,211,238,.28), rgba(167,139,250,.28)); border-color: rgba(34,211,238,.55)}
    .btn.danger{border-color: rgba(239,68,68,.5); color:#fecaca}
    .btn.small{padding:10px 12px; font-size:14px; min-height:44px}
    .grid-two{display:grid; grid-template-columns: 1fr; gap:12px}
    @media(min-width:720px){ .grid-two{ grid-template-columns: 1fr 1fr } }
    textarea, input[type=text], input[type=email], input[type=tel], input[type=url]{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.18);
      background:rgba(17,24,39,.7); color:var(--text); font-size:15px
    }
    .ocrtext{white-space:pre-wrap; font-family: ui-monospace,SFMono-Regular, Menlo, monospace; font-size:12px; line-height:1.28;
             max-height:160px; overflow:auto; background:#0b1020; border:1px solid rgba(148,163,184,.18); border-radius:10px; padding:8px}
    .list{display:grid; gap:10px; margin-top:10px}
    .item{background:rgba(15,23,42,.85); border:1px solid rgba(148,163,184,.18); padding:12px; border-radius:14px}
    .item h3{margin:0 0 6px 0; font-size:16px}
    .pill{font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.25); color:#bae6fd}
    .tag{display:inline-flex; align-items:center; padding:2px 8px; font-size:12px; border-radius:999px;
         border:1px solid rgba(148,163,184,.25); color:#c7d2fe; margin-right:6px}
    .progress{height:8px; background:#0b1020; border-radius:999px; overflow:hidden; border:1px solid rgba(148,163,184,.2)}
    .progress>div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2))}
    .toast{position:fixed; bottom:calc(14px + var(--safe-bottom)); left:50%; transform:translateX(-50%);
           background:rgba(2,6,23,.94); border:1px solid rgba(148,163,184,.25);
           color:var(--text); padding:10px 14px; border-radius:12px; display:none; z-index:60}
    .dock{ position:fixed; z-index:55; left:0; right:0; bottom:0;
      background: linear-gradient(0deg, rgba(11,16,32,0.95), rgba(11,16,32,0.7));
      border-top:1px solid rgba(148,163,184,.18);
      padding:10px 12px calc(10px + var(--safe-bottom));
    }
    .dock .row{justify-content:space-between}
    .dock .btn{flex:1; text-align:center}
    .dock .btn + .btn{margin-left:8px}
    details{border:1px solid rgba(148,163,184,.18); border-radius:12px; padding:10px 12px; background:rgba(17,24,39,.6)}
    summary{cursor:pointer}
    .hint{font-size:12px; color:#cbd5e1}
    .error{color:#fecaca}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>CardVault <span class="badge">Mobile</span></h1>
      <div class="search" style="margin-top:10px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 21l-3.5-3.5m1.5-5.5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="q" type="search" inputmode="search" autocomplete="off" placeholder="Search name, company, keywords‚Ä¶" />
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2 class="section-title">New Scan</h2>
      <p class="muted" style="margin:0 0 10px 0;">Scan front & back, extract text, auto-fill fields, add notes/tags, save.</p>
      <div class="preview" id="previewRow">
        <div class="thumb" id="frontThumb"><span class="muted">Front</span></div>
        <div class="thumb" id="backThumb"><span class="muted">Back</span></div>
      </div>

      <div class="grid-two" style="margin-top:10px">
        <div>
          <label class="file btn small" style="width:100%; justify-content:center">
            <input id="frontFile" type="file" accept="image/*" capture="environment">
            üì∑ Scan Front
          </label>
        </div>
        <div>
          <label class="file btn small" style="width:100%; justify-content:center">
            <input id="backFile" type="file" accept="image/*" capture="environment">
            üì∑ Scan Back (optional)
          </label>
        </div>
      </div>

      <div id="progressWrap" style="margin-top:12px; display:none">
        <div class="progress"><div id="progressBar"></div></div>
        <div class="muted" id="progressMsg" style="margin-top:6px; font-size:12px">Running OCR‚Ä¶</div>
      </div>

      <div style="margin-top:12px" class="grid-two">
        <div>
          <label class="muted">Name</label>
          <input id="name" type="text" placeholder="e.g., Jane Doe">
        </div>
        <div>
          <label class="muted">Company</label>
          <input id="company" type="text" placeholder="e.g., Acme Ltd">
        </div>
      </div>
      <div class="grid-two" style="margin-top:10px">
        <div>
          <label class="muted">Email</label>
          <input id="email" type="email" inputmode="email" placeholder="email@example.com">
        </div>
        <div>
          <label class="muted">Phone</label>
          <input id="phone" type="tel" inputmode="tel" placeholder="+94 ...">
        </div>
      </div>
      <div style="margin-top:10px">
        <label class="muted">Website</label>
        <input id="website" type="url" inputmode="url" placeholder="https://example.com">
      </div>
      <div class="grid-two" style="margin-top:10px">
        <div>
          <label class="muted">Title (auto)</label>
          <input id="title" type="text" placeholder="Jane Doe ‚Äî Acme Ltd">
        </div>
        <div>
          <label class="muted">Tags (comma)</label>
          <input id="tags" type="text" placeholder="client, vendor, hot lead">
        </div>
      </div>
      <div style="margin-top:10px">
        <label class="muted">Notes</label>
        <textarea id="notes" rows="3" placeholder="Met at SLASSCOM fintech panel, follow up Tuesday"></textarea>
      </div>
      <div style="margin-top:10px">
        <label class="muted">Extracted Text</label>
        <div id="ocrOut" class="ocrtext">(empty)</div>
        <div class="hint" id="ocrHint" style="margin-top:6px"></div>
      </div>
    </section>

    <section style="margin-top:16px">
      <div class="row" style="justify-content:space-between">
        <h2 class="section-title" style="margin:0">Saved Cards</h2>
        <div class="row">
          <button class="btn small" id="btnExport">‚¨áÔ∏è JSON</button>
          <button class="btn small" id="btnCsv">‚¨áÔ∏è CSV</button>
          <button class="btn danger small" id="btnWipe">üóëÔ∏è Clear</button>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>
  </main>

  <div class="dock">
    <div class="row">
      <button class="btn" id="btnOcr">üîé Extract</button>
      <button class="btn primary" id="btnSave" disabled>üíæ Save</button>
      <button class="btn" id="btnReset">‚ôªÔ∏è Reset</button>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const $ = (sel) => document.querySelector(sel);
    const byId = id => document.getElementById(id);
    const toast = (msg) => { const t = byId('toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1600); };
    const setHint = (msg, isError=false) => { const h = byId('ocrHint'); h.textContent = msg||''; h.className = isError ? 'hint error' : 'hint'; };

    const compressImage = (file, maxEdge=1600, quality=.85) => new Promise((res, rej)=>{
      const img = new Image();
      img.onload = ()=>{
        const w0 = img.naturalWidth, h0 = img.naturalHeight;
        const scale = Math.min(1, maxEdge / Math.max(w0, h0));
        const w = Math.round(w0 * scale), h = Math.round(h0 * scale);
        const c = document.createElement('canvas'); c.width=w; c.height=h;
        const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        res(c.toDataURL('image/jpeg', quality));
      };
      img.onerror = rej;
      const reader = new FileReader();
      reader.onload = () => img.src = reader.result;
      reader.readAsDataURL(file);
    });

    const store = {
      key: 'cv_cards_v3',
      all(){ try { return JSON.parse(localStorage.getItem(this.key) || '[]'); } catch(e){ return [] } },
      save(cards){ localStorage.setItem(this.key, JSON.stringify(cards)); },
      add(card){ const cards = this.all(); cards.unshift(card); this.save(cards); return cards; },
      wipe(){ localStorage.removeItem(this.key); }
    };

    const state = { frontDataURL:null, backDataURL:null, ocrFront:'', ocrBack:'',
      ocrAll(){ return [this.ocrFront, this.ocrBack].filter(Boolean).join('\n'); } };

    const progressWrap = byId('progressWrap');
    const progressBar = byId('progressBar');
    const progressMsg = byId('progressMsg');

    async function recognizeDataURL(dataURL, worker){
      const res = await worker.recognize(dataURL);
      return (res && res.data && res.data.text) ? res.data.text : '';
    }

    async function runOCR(){
      if(!state.frontDataURL && !state.backDataURL){ toast('Add at least the front image'); return; }
      byId('ocrOut').textContent = '(processing‚Ä¶)';
      setHint('First run needs internet to fetch OCR engine.');
      progressWrap.style.display = 'block'; progressBar.style.width = '0%'; progressMsg.textContent = 'Initializing‚Ä¶';

      let worker;
      try{
        worker = await Tesseract.createWorker({ logger: m => {
          if(m.status && m.progress!=null){
            progressMsg.textContent = m.status.replace(/_/g,' ') + '‚Ä¶';
            progressBar.style.width = Math.round(m.progress*100) + '%';
          }
        }});
        await worker.loadLanguage('eng');
        await worker.initialize('eng');

        state.ocrFront = state.frontDataURL ? await recognizeDataURL(state.frontDataURL, worker) : '';
        state.ocrBack  = state.backDataURL  ? await recognizeDataURL(state.backDataURL, worker) : '';
      } catch(e){
        console.error(e);
        setHint('OCR failed to load. Check internet on first run or content blockers.', true);
        toast('OCR failed');
      } finally{
        try{ await worker.terminate(); }catch(_){}
      }

      const text = state.ocrAll().trim();
      byId('ocrOut').textContent = text || '(no text found)';
      autoFillFromText(text);
      byId('btnSave').disabled = text.length === 0;
      progressWrap.style.display = 'none';
      setHint(text ? 'Tap Save to store the card. Edit any field before saving.' : '');
    }

    function autoFillFromText(text){
      const fields = extractFields(text);
      if(!byId('name').value && fields.name) byId('name').value = fields.name;
      if(!byId('company').value && fields.company) byId('company').value = fields.company;
      if(!byId('email').value && fields.email) byId('email').value = fields.email;
      if(!byId('phone').value && fields.phone) byId('phone').value = fields.phone;
      if(!byId('website').value && fields.website) byId('website').value = fields.website;
      if(!byId('title').value){
        const t = [fields.name, fields.company].filter(Boolean).join(' ‚Äî ');
        byId('title').value = t || suggestTitle(text);
      }
    }

    function suggestTitle(txt){
      const lines = (txt||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const drop = /\b(email|mail|phone|tel|mobile|mob|www|http|fax|address|add\.?|street|road|rd\.|st\.)\b/i;
      for(const l of lines){
        if(l.length >= 3 && !drop.test(l)) return l.slice(0,64);
      }
      return 'New Contact';
    }

    function extractFields(text){
      const email = (text.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)||[])[0] || '';
      const phone = (text.match(/(?:\+\d{1,3}[\s.-]?)?(?:\(?\d{2,4}\)?[\s.-]?)?\d{3,4}[\s.-]?\d{3,4}/)||[])[0] || '';
      const website = (text.match(/https?:\/\/[\w.-]+(?:\/[\w./-]*)?/i)||text.match(/\b(?:www\.)?[\w.-]+\.[a-z]{2,}(?:\/[\w./-]*)?/i)||[])[0] || '';
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const contactish = /(email|mail|phone|tel|mobile|mob|www|http|fax|address|add\.?|street|road|rd\.|st\.|p\.?o\.? box|suite|level|floor|lk|com|net|org|io|co\b)/i;
      const candidates = lines.filter(l => l.length>2 && !contactish.test(l));
      const name = candidates[0] || '';
      const company = candidates[1] && candidates[1] !== name ? candidates[1] : '';
      return {email, phone, website, name, company};
    }

    function renderList(q=''){
      const list = byId('list');
      const cards = store.all();
      const needle = q.trim().toLowerCase();
      const filtered = !needle ? cards : cards.filter(c => (c.title + ' ' + c.text + ' ' + c.notes + ' ' + (c.tags||[]).join(' ')).toLowerCase().includes(needle));
      list.innerHTML = '';
      if(filtered.length === 0){
        const p = document.createElement('p'); p.className='muted'; p.textContent = 'No cards yet.'; list.appendChild(p); return;
      }
      for(const c of filtered){
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <h3>${escapeHtml(c.title)}</h3>
            <span class="pill">${new Date(c.createdAt).toLocaleDateString()}</span>
          </div>
          <div class="muted" style="margin:6px 0">${escapeHtml(c.notes || '')}</div>
          <div style="display:flex; flex-wrap:wrap; gap:6px; margin:6px 0">${(c.tags||[]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join('')}</div>
          <div class="row" style="gap:8px; margin-top:8px">
            <button class="btn small" data-id="${c.id}" data-act="open" style="flex:1">üîç View</button>
            <button class="btn small" data-id="${c.id}" data-act="vcard" style="flex:1">üìá vCard</button>
            <button class="btn danger small" data-id="${c.id}" data-act="del" style="flex:1">üóëÔ∏è Delete</button>
          </div>`;
        list.appendChild(div);
      }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function vcardFor(card){
      const safe = s => (s||'').replace(/\n/g,'\\n').replace(/,/g,'\,');
      const v = [
        'BEGIN:VCARD','VERSION:3.0',
        'N:;'+safe(card.name||'')+';;;',
        'FN:'+safe(card.title || card.name || ''),
        card.company ? ('ORG:'+safe(card.company)) : null,
        card.phone ? ('TEL;TYPE=CELL:'+card.phone) : null,
        card.email ? ('EMAIL;TYPE=INTERNET:'+card.email) : null,
        card.website ? ('URL:'+safe(card.website)) : null,
        card.notes ? ('NOTE:'+safe(card.notes)) : null,
        'END:VCARD'
      ].filter(Boolean).join('\n');
      const blob = new Blob([v], {type:'text/vcard'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (card.title||'contact') + '.vcf'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    byId('frontFile').addEventListener('change', async (e)=>{
      if(!e.target.files[0]) return;
      const dataURL = await compressImage(e.target.files[0], 1600, .85);
      state.frontDataURL = dataURL; byId('frontThumb').innerHTML = '<img alt="front" src="'+dataURL+'">';
      byId('btnSave').disabled = true;
    });
    byId('backFile').addEventListener('change', async (e)=>{
      if(!e.target.files[0]) return;
      const dataURL = await compressImage(e.target.files[0], 1600, .85);
      state.backDataURL = dataURL; byId('backThumb').innerHTML = '<img alt="back" src="'+dataURL+'">';
      byId('btnSave').disabled = true;
    });
    byId('btnOcr').addEventListener('click', runOCR);
    byId('btnReset').addEventListener('click', ()=>{
      state.frontDataURL=null; state.backDataURL=null; state.ocrFront=''; state.ocrBack='';
      byId('frontThumb').innerHTML='<span class="muted">Front</span>';
      byId('backThumb').innerHTML='<span class="muted">Back</span>';
      byId('ocrOut').textContent='(empty)'; setHint('');
      ['name','company','email','phone','website','title','tags','notes'].forEach(id => byId(id).value='');
      byId('btnSave').disabled = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    byId('btnSave').addEventListener('click', ()=>{
      const card = {
        id: crypto.randomUUID(),
        title: byId('title').value || 'New Contact',
        name: byId('name').value || '',
        company: byId('company').value || '',
        email: byId('email').value || '',
        phone: byId('phone').value || '',
        website: byId('website').value || '',
        front: state.frontDataURL, back: state.backDataURL,
        text: state.ocrAll(),
        notes: byId('notes').value || '',
        tags: (byId('tags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        createdAt: new Date().toISOString()
      };
      store.add(card); renderList(byId('q').value); toast('Saved');
      byId('btnReset').click();
    });

    byId('btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(store.all(), null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='cardvault-export.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    });
    byId('btnCsv').addEventListener('click', ()=>{
      const cards = store.all();
      const rows = [['title','name','company','email','phone','website','notes','tags','createdAt','text']];
      for (const c of cards){
        rows.push([c.title,c.name||'',c.company||'',c.email||'',c.phone||'',c.website||'',
          (c.notes||'').replace(/\n/g,' '),(c.tags||[]).join(';'),c.createdAt,(c.text||'').replace(/\n/g,' ')]);
      }
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='cardvault-export.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    });

    byId('list').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
      const cards = store.all(); const idx = cards.findIndex(c=>c.id===id); if(idx<0) return;
      if(act==='del'){ if(confirm('Delete this card?')){ cards.splice(idx,1); store.save(cards); renderList(byId('q').value); toast('Deleted'); } }
      else if(act==='vcard'){ vcardFor(cards[idx]); }
      else if(act==='open'){ openViewer(cards[idx]); }
    });

    let searchTimer = null;
    byId('q').addEventListener('input', (e)=>{ clearTimeout(searchTimer); searchTimer = setTimeout(()=>renderList(e.target.value), 120); });

    function openViewer(card){
      const list = byId('list');
      const container = Array.from(list.children).find(el => el.querySelector(`[data-id="${card.id}"]`));
      if(!container) return;
      let details = container.querySelector('details');
      if(details){ details.open = !details.open; return; }
      details = document.createElement('details'); details.open = true;
      const imgFront = card.front ? `<img src="${card.front}" alt="front" style="width:100%; border-radius:10px">` : '';
      const imgBack = card.back ? `<img src="${card.back}" alt="back" style="width:100%; border-radius:10px; margin-top:8px">` : '';
      const info = [`<b>${escapeHtml(card.name||'')}</b>`, escapeHtml(card.company||''), escapeHtml(card.email||''), escapeHtml(card.phone||''), escapeHtml(card.website||'')].filter(Boolean).join(' ¬∑ ');
      details.innerHTML = `
        <summary class="muted">View images & text</summary>
        <div style="margin-top:10px">${imgFront}${imgBack}</div>
        <div style="margin-top:8px" class="hint">${info}</div>
        <div class="ocrtext" style="margin-top:10px">${escapeHtml(card.text)}</div>`;
      container.appendChild(details);
      details.scrollIntoView({behavior:'smooth', block:'center'});
    }

    renderList();

    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
    }
  </script>
</body>
</html>
